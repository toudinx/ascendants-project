<div
  class="battle-root"
  data-testid="run-battle-page"
  [class.hit-pause]="hitPauseActive()"
  [class.is-paused]="paused"
  [class.reduce-motion]="prefersReducedMotion"
  [class.reduce-flash]="vfxSettings.reduceFlash()"
  [class.ruina-evolved]="activeEvolution?.cssClass === 'ruina-evolved'"
  [class.impacto-evolved]="activeEvolution?.cssClass === 'impacto-evolved'"
  [class.critico-evolved]="activeEvolution?.cssClass === 'critico-evolved'"
  [style.--vfx-intensity]="(vfxIntensity$ | async) ?? 0"
  [style.--ui-scale]="uiScale"
>
@if (hasBattleActors) {
  <div class="battle-body">
    <div class="battle-card">
      <div class="battle-stage">
        <app-arena-container #arenaRoot>
          <div arena-background>
            <img
              class="arena-bg"
              src="assets/battle/arena/arena_ruin_base.png"
              alt="Arena"
            />
            <app-ground-ripple-layer
              [anchors]="fxAnchors"
              [reduceMotion]="prefersReducedMotion"
            ></app-ground-ripple-layer>
          </div>

          <div arena-actors>
            <app-actor-sprite
              #playerActor
              side="player"
              [pose]="actorPose('player')"
              [spriteKey]="playerSprite"
              [impactFlags]="impactFlagsFor('player')"
              [flash]="ui.state().flashPlayer"
              [showDot]="hasDot('player')"
              [hasBuff]="hasBuff('player')"
              [energyFull]="energyFull('player')"
              [isBroken]="isPlayerBroken"
              [isSuperBroken]="isPlayerSuperBroken"
              [echoCount]="echoCountFor('player')"
              [resonanceActive]="resonanceActiveFor('player')"
              [reduceMotion]="prefersReducedMotion"
              [hitToken]="actorHitToken('player')"
              [critToken]="actorCritToken('player')"
              [dotPulseToken]="actorDotToken('player')"
              [altText]="playerName"
              (impactAnimationEnd)="onImpactAnimationEnd('player', $event)"
            ></app-actor-sprite>

            <app-actor-sprite
              #enemyActor
              side="enemy"
              [pose]="actorPose('enemy')"
              [spriteKey]="enemySprite"
              [impactFlags]="impactFlagsFor('enemy')"
              [flash]="ui.state().flashEnemy"
              [showAlert]="enemyPreparing"
              [showDot]="hasDot('enemy')"
              [hasBuff]="hasBuff('enemy')"
              [energyFull]="energyFull('enemy')"
              [isBroken]="isEnemyBroken"
              [isSuperBroken]="isEnemySuperBroken"
              [echoCount]="echoCountFor('enemy')"
              [resonanceActive]="resonanceActiveFor('enemy')"
              [reduceMotion]="prefersReducedMotion"
              [hitToken]="actorHitToken('enemy')"
              [critToken]="actorCritToken('enemy')"
              [dotPulseToken]="actorDotToken('enemy')"
              altText="Enemy"
              (impactAnimationEnd)="onImpactAnimationEnd('enemy', $event)"
            ></app-actor-sprite>
          </div>

          <div arena-vfx>
            <app-vfx-layer
              [anchors]="fxAnchors"
              [echoPaths]="echoSignaturePaths"
              [reduceMotion]="prefersReducedMotion"
            ></app-vfx-layer>
          </div>

          <div arena-ui>
            <div class="target-highlight-layer">
              @if (highlightBoxes().player; as box) {
                <div
                  class="target-highlight"
                  [class.superbroken]="box.variant === 'superbroken'"
                  [class.broken]="box.variant === 'broken'"
                  [style.left.px]="box.left"
                  [style.top.px]="box.top"
                  [style.width.px]="box.size"
                  [style.height.px]="box.size"
                ></div>
              }
              @if (highlightBoxes().enemy; as box) {
                <div
                  class="target-highlight"
                  [class.superbroken]="box.variant === 'superbroken'"
                  [class.broken]="box.variant === 'broken'"
                  [style.left.px]="box.left"
                  [style.top.px]="box.top"
                  [style.width.px]="box.size"
                  [style.height.px]="box.size"
                ></div>
              }
            </div>
            <app-combat-text-layer
              [anchors]="fxAnchors"
              [reduceMotion]="prefersReducedMotion"
            ></app-combat-text-layer>

            @if (paused) {
              <div class="pause-veil">
                <div class="pause-copy">
                  <span class="pause-icon">⏸</span>
                  <span>Combat paused</span>
                </div>
              </div>
            }
          </div>
        </app-arena-container>
      </div>
      <div class="battle-hud">
        @if (activeEvolution) {
          <div class="evolution-banner">
            <div class="badge" [attr.title]="activeEvolution.description">
              <span class="icon">{{ activeEvolution.icon || '✶' }}</span>
              <span class="label">{{ activeEvolution.name }}</span>
            </div>
          </div>
        }
        <div class="hud-status-row">
          <div
            class="status-card player"
            [ngClass]="{
              broken: isPlayerBroken,
              superbroken: isPlayerSuperBroken,
              'hp-low': isHpLow(playerState.attributes.hp, playerState.attributes.maxHp),
              'posture-low': isPostureLow(playerState.attributes.posture, playerState.attributes.maxPosture)
            }"
          >
            <div class="status-header">
              <div>
                <strong>{{ playerName }}</strong>
                <span class="subtitle">Ascendant</span>
              </div>
              <div class="state-pills">
                @if (playerHitCount > 1) {
                  <span class="status-pill hit">HIT x{{ playerHitCount }}</span>
                }
                @if (hasDot('player')) {
                  <span
                    class="status-pill dot"
                    [class.dot-pulse]="hasImpact('player', 'hit-dot')"
                  >
                    <span>DoT</span>
                    <span class="dot-count">x{{ dotCountFor('player') }}</span>
                    @if (dotElementsFor('player').length) {
                      <span class="dot-elements">
                        @for (element of dotElementsFor('player'); track element) {
                          <span class="dot-element" [class]="element"></span>
                        }
                      </span>
                    }
                  </span>
                }
                @if (isPlayerBroken) {
                  <span class="status-pill break"
                    >Broken {{ playerState.breakTurns || 0 }}T</span
                  >
                }
                @if (isPlayerSuperBroken) {
                  <span class="status-pill super"
                    >Superbroken {{ playerState.breakTurns || 0 }}T</span
                  >
                }
              </div>
            </div>
            <div class="status-meter">
              <span class="label">HP</span>
              <div class="meter">
                <div
                  class="meter-fill hp"
                  [ngClass]="{ 'crit-active': hasImpact('player', 'hit-lg') }"
                  [style.width]="meterWidth(playerState.attributes.hp, playerState.attributes.maxHp)"
                ></div>
              </div>
              <span class="meter-value"
                >{{ playerState.attributes.hp }} / {{
                playerState.attributes.maxHp }}</span
              >
            </div>
            <div class="status-meter">
              <span class="label">EP</span>
              <div class="meter">
                <div
                  class="meter-fill ep"
                  [style.width]="meterWidth(playerState.attributes.energy, playerState.attributes.maxEnergy)"
                ></div>
              </div>
              <span class="meter-value"
                >{{ playerState.attributes.energy }} / {{
                playerState.attributes.maxEnergy }}</span
              >
            </div>
            <div class="status-meter">
              <span class="label">Posture</span>
              <div class="meter">
                <div
                  class="meter-fill shield"
                  [ngClass]="{ 'posture-spark': hasImpact('player', 'hit-posture') }"
                  [style.width]="meterWidth(playerState.attributes.posture, playerState.attributes.maxPosture)"
                ></div>
              </div>
              <span class="meter-value"
                >{{ playerState.attributes.posture }} / {{
                playerState.attributes.maxPosture }}</span
              >
            </div>
          </div>

          <div
            class="status-card enemy"
            [ngClass]="{
              broken: isEnemyBroken,
              superbroken: isEnemySuperBroken,
              'hp-low': isHpLow(enemyState.attributes.hp, enemyState.attributes.maxHp),
              'posture-low': isPostureLow(enemyState.attributes.posture, enemyState.attributes.maxPosture)
            }"
          >
            <div class="status-header">
              <div>
                <strong>{{ enemyState.attributes.name }}</strong>
                @if (enemyPreparing) {
                  <span class="subtitle">Preparing attack</span>
                }
                @if (!enemyPreparing) {
                  <span class="subtitle">{{ enemyState.state | uppercase }}</span>
                }
              </div>
              <div class="state-pills">
                @if (enemyPreparing) {
                  <span class="status-pill alert">ALERT</span>
                }
                @if (isEnemyBroken) {
                  <span class="status-pill break"
                    >Broken {{ enemyState.breakTurns || 0 }}T</span
                  >
                }
                @if (isEnemySuperBroken) {
                  <span class="status-pill super"
                    >Superbroken {{ enemyState.breakTurns || 0 }}T</span
                  >
                }
                @if (hasDot('enemy')) {
                  <span
                    class="status-pill dot"
                    [class.dot-pulse]="hasImpact('enemy', 'hit-dot')"
                  >
                    <span>DoT</span>
                    <span class="dot-count">x{{ dotCountFor('enemy') }}</span>
                    @if (dotElementsFor('enemy').length) {
                      <span class="dot-elements">
                        @for (element of dotElementsFor('enemy'); track element) {
                          <span class="dot-element" [class]="element"></span>
                        }
                      </span>
                    }
                  </span>
                }
              </div>
            </div>
            <div class="status-meter">
              <span class="label">HP</span>
              <div class="meter">
                <div
                  class="meter-fill hp"
                  [ngClass]="{ 'crit-active': hasImpact('enemy', 'hit-lg') }"
                  [style.width]="meterWidth(enemyState.attributes.hp, enemyState.attributes.maxHp)"
                ></div>
              </div>
              <span class="meter-value"
                >{{ enemyState.attributes.hp }} / {{ enemyState.attributes.maxHp
                }}</span
              >
            </div>
            <div class="status-meter">
              <span class="label">Posture</span>
              <div class="meter">
                <div
                  class="meter-fill shield"
                  [ngClass]="{ 'posture-spark': hasImpact('enemy', 'hit-posture') }"
                  [style.width]="meterWidth(enemyState.attributes.posture, enemyState.attributes.maxPosture)"
                ></div>
              </div>
              <span class="meter-value"
                >{{ enemyState.attributes.posture }} / {{
                enemyState.attributes.maxPosture }}</span
              >
            </div>
          </div>
        </div>

        <div class="hud-actions">
          <div class="action-hint">
            @if (autoplay) {
              <span
                >Autoplay active: {{ playerName }} attacks and uses ability when
                ready.</span
              >
            }
            @if (!autoplay && awaitingPlayer) {
              <span>Manual mode: choose the action for the turn.</span>
            }
            @if (!autoplay && !awaitingPlayer) {
              <span>Waiting for player's next turn...</span>
            }
          </div>
          <div class="action-buttons">
            <button
              type="button"
              class="action-btn primary"
              [class.indicator]="autoplay"
              [disabled]="!manualActionReady"
              (click)="handleAutoAttack()"
            >
              <div class="action-label">
                <span>Auto-attack</span>
                @if (autoplay) {
                  <small>Indicator</small>
                }
                @if (!autoplay) {
                  <small>Execute turn</small>
                }
              </div>
            </button>

            <button
              type="button"
              class="action-btn skill"
              [ngClass]="{
                ready: skillButtonEnabled && !skillOnCooldown && !skillEnergyBlocked,
                cooldown: skillOnCooldown,
                blocked: skillEnergyBlocked
              }"
              [disabled]="!skillButtonEnabled"
              (click)="handleActiveSkill()"
            >
              <div class="action-label">
                <span>Active skill</span>
                <small>Cost {{ skillCost }} EP</small>
              </div>
              @if (skillOnCooldown) {
                <div class="skill-state">On cooldown</div>
              }
              @if (skillEnergyBlocked && !skillOnCooldown) {
                <div class="skill-state">Insufficient EP</div>
              }
              @if (skillButtonEnabled && !skillOnCooldown && !skillEnergyBlocked) {
                <div class="skill-state highlight">Ready</div>
              }
              @if (skillOnCooldown) {
                <div
                  class="cooldown-veil"
                  [style.--cooldown]="skillCooldownRatio"
                ></div>
              }
            </button>
          </div>

          <div class="action-toggles">
            <button
              type="button"
              class="chip ghost"
              (click)="toggleAutoplay()"
              [attr.aria-pressed]="autoplay"
            >
              <span class="dot" [class.on]="autoplay"></span>
              <span>{{ autoplay ? 'Autoplay ON' : 'Manual' }}</span>
            </button>
            <button type="button" class="chip ghost" (click)="togglePause()">
              <span class="icon">{{ paused ? '▶' : '⏸' }}</span>
              <span>{{ paused ? 'Resume' : 'Pause' }}</span>
            </button>
            <button type="button" class="chip ghost" (click)="toggleLog()">
              <span class="icon">≡</span>
              <span>{{ logOpen ? 'Close log' : 'Open log' }}</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <aside class="log-dock" [class.open]="logOpen" aria-label="Action log">
      <div class="log-dock__header">
        <div class="log-title">
          <span class="icon">ƒ%­</span>
          <span>Combat Log</span>
        </div>
        <button type="button" class="chip ghost" (click)="toggleLog()">
          {{ logOpen ? 'Close' : 'Open' }}
        </button>
      </div>
      <div #logBody class="log-dock__body" role="region" aria-live="polite">
        @if (turnTimeline.length) {
          @for (turn of turnTimeline; track turn.id) {
            <div
              class="log-turn"
              [class.collapsed]="isTurnCollapsed(turn.id)"
              [attr.data-turn-id]="turn.id"
            >
              <button
                type="button"
                class="log-turn__header"
                (click)="toggleTurnCollapse(turn.id)"
                [attr.aria-expanded]="!isTurnCollapsed(turn.id)"
              >
                <div class="log-turn__meta">
                  <span class="log-turn__label">Turn {{ turn.number }}</span>
                  <span class="log-turn__actor"
                    >{{ turn.actorLabel | uppercase }}</span
                  >
                </div>
                <div class="log-turn__status">
                  @if (turn.isLatest) {
                    <span class="log-turn__badge">LIVE</span>
                  }
                  <span class="log-turn__caret" aria-hidden="true"></span>
                </div>
              </button>
              <div class="log-turn__summary-line">
                @for (chip of turn.summary; track $index) {
                  <span class="summary-chip" [ngClass]="chip.tone">{{
                    chip.text
                  }}</span>
                }
              </div>
              @if (!isTurnCollapsed(turn.id)) {
                <div class="log-turn__body">
                  <div class="log-turn__events">
                    @for (event of turn.events; track event.id) {
                      <div class="log-event" [ngClass]="event.tone">
                        <span class="log-event__icon">{{ event.icon }}</span>
                        <span class="log-event__text">{{ event.text }}</span>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          }
        } @else {
          <div class="log-entry">No events yet. Combat syncs here.</div>
        }
      </div>
    </aside>
  </div>
} @else {
  <div class="pause-overlay">
    <div class="pause-modal">
      <div class="pause-title">
        <span class="icon">?</span>
        <div>
          <strong>Combat paused</strong>
          <small>Waiting for combat data.</small>
        </div>
      </div>
      <div class="pause-actions">
        <button
          type="button"
          class="action-btn primary"
          (click)="togglePause()"
        >
          Resume
        </button>
        <button type="button" class="action-btn ghost" (click)="abandonRun()">
          Abandon run
        </button>
      </div>
    </div>
  </div>
}

@if (evolutionOverlay(); as evo) {
  <div
    class="evolution-overlay"
    (animationend)="onEvolutionOverlayEnd()"
    [class.reduce-motion]="prefersReducedMotion"
  >
    <div class="overlay-card">
      <div class="icon">{{ evo.icon || '✶' }}</div>
      <div class="copy">
        <span class="kicker">Evolution Unlocked</span>
        <strong>{{ evo.name }}</strong>
      </div>
    </div>
  </div>
}

<app-run-debug-panel></app-run-debug-panel>

</div>
